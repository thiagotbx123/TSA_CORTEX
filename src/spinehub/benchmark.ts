/**
 * RAC-14 Benchmark - Quality Standard for Worklog Output
 *
 * This file defines the EXACT structure and quality criteria
 * that all worklog outputs must match.
 *
 * RAC-14 was the first worklog that achieved the desired quality.
 * This benchmark ensures we never regress.
 */

/**
 * The structure of a high-quality worklog output
 */
export interface WorklogBenchmark {
  // Header section
  title: string;                    // "[Worklog]YY_MM_DD TSA {Owner Name}"

  // Summary table
  summary: {
    period: string;                 // "Dec 22 to Dec 23, 2025"
    owner: string;                  // "Thiago Rodrigues"
    sources: SourceCount[];         // Array of source counts
    total: number;                  // Sum of all sources (MUST reconcile)
    generationTime: string;         // "12s"
  };

  // Objective section (NEW - learned from RAC-14 iterations)
  objective: string;                // 1 paragraph describing the period's focus

  // Thematic sections (the narrative)
  themes: ThemeSection[];

  // References table at the end
  references: Reference[];

  // Signature
  signature: string;                // "Generated by TSA_CORTEX v{version}"
}

export interface SourceCount {
  source: 'Slack' | 'Drive' | 'Linear' | 'Local' | 'Claude';
  count: number;
}

export interface ThemeSection {
  name: string;                     // Theme title (e.g., "WFS Onboarding")
  narrative: string;                // The story (third person, English)
  artifacts: ArtifactLink[];        // Links with descriptions
  outcome: string;                  // What was achieved
}

export interface ArtifactLink {
  name: string;                     // Display name
  url: string;                      // Clickable link
  description: string;              // What this artifact is
}

export interface Reference {
  id: number;                       // Sequential reference number
  source: string;                   // Source type
  description: string;              // What it is
  url: string;                      // Link
}

/**
 * Quality validation rules from RAC-14 learnings
 */
export const QUALITY_RULES = {
  // CRITICAL: Language and person
  LANGUAGE: 'English 100%',
  PERSON: 'Third person ("Thiago worked on...")',
  TONE: 'Human-like, intermediate level, not robotic',

  // CRITICAL: Slack handling
  SLACK_RULE: 'NEVER quote Slack messages directly. Use for CONTEXT ONLY.',
  SLACK_WRONG: '"Thiago said: \'posso te chamar?\'"',
  SLACK_RIGHT: '"Thiago coordinated with Gabrielle on technical details"',

  // CRITICAL: Count reconciliation
  COUNTS_MUST_RECONCILE: true,
  COUNT_FORMULA: 'Slack + Drive + Linear + Local + Claude = Total',

  // CRITICAL: Title format
  TITLE_SHORT_PERIOD: 'Worklog (for periods < 7 days)',
  TITLE_LONG_PERIOD: 'Weekly Worklog (for periods >= 7 days)',

  // CRITICAL: All channels with my_work > 0 must be represented
  CHANNEL_COVERAGE: 'Every Slack channel with my_work > 0 must appear in narrative',

  // Artifacts must have links
  ARTIFACTS_REQUIRE_LINKS: true,

  // Structure requirements
  REQUIRES_OBJECTIVE: true,
  REQUIRES_OUTCOME_PER_THEME: true,
  REQUIRES_REFERENCES_TABLE: true,
  REQUIRES_SIGNATURE: true,
};

/**
 * RAC-14 template as reference
 */
export const RAC_14_TEMPLATE = `
# Worklog - {Owner Name}

| Field | Value |
|-------|-------|
| Period | {start_date} to {end_date} |
| Owner | {owner_name} |
| Slack | {slack_count} events |
| Drive | {drive_count} events |
| Linear | {linear_count} events |
| Local | {local_count} events |
| Claude | {claude_count} events |
| **Total** | **{total_count} events** |
| Generation Time | {gen_time}s |

## Objective

{One paragraph describing the main focus and scope of work during this period.}

---

### {Theme 1 Name}

{Narrative paragraph describing what happened. Third person. English. No Slack quotes.}

**Artifacts:**
- [{Artifact 1 Name}]({url}) - {description}
- [{Artifact 2 Name}]({url}) - {description}

**Outcome:** {What was achieved or the current status.}

---

### {Theme 2 Name}

{Narrative paragraph...}

**Artifacts:**
- ...

**Outcome:** ...

---

## References

| # | Source | Description | Link |
|---|--------|-------------|------|
| 1 | Drive | {description} | [open]({url}) |
| 2 | Slack | {description} | [open]({url}) |
| ... | ... | ... | ... |

---

*Generated by TSA_CORTEX v{version}*
`;

/**
 * Validation function to check if output matches benchmark quality
 */
export function validateWorklogQuality(content: string): {
  valid: boolean;
  score: number;
  issues: string[];
} {
  const issues: string[] = [];
  let score = 100;

  // Check for Portuguese (should be 0%)
  const portuguesePatterns = [
    /\bde\b.*\bque\b/i,
    /\bestá\b/i,
    /\bpara\b/i,
    /\bcom\b/i,
    /\bnão\b/i,
    /\bfoi\b/i,
    /\bem\b.*\bde\b/i,
  ];

  for (const pattern of portuguesePatterns) {
    if (pattern.test(content)) {
      issues.push('Contains Portuguese text - must be 100% English');
      score -= 20;
      break;
    }
  }

  // Check for Slack quotes (should be 0)
  const slackQuotePatterns = [
    /said:\s*['"]/i,
    /wrote:\s*['"]/i,
    /messaged:\s*['"]/i,
    /"[^"]+"\s*-\s*\w+\s+in\s+#/i,
  ];

  for (const pattern of slackQuotePatterns) {
    if (pattern.test(content)) {
      issues.push('Contains Slack message quotes - use context only, never quote');
      score -= 25;
      break;
    }
  }

  // Check for first person (should be third person)
  const firstPersonPatterns = [
    /\bI worked\b/i,
    /\bI created\b/i,
    /\bI updated\b/i,
    /\bmy work\b/i,
    /\bI discussed\b/i,
  ];

  for (const pattern of firstPersonPatterns) {
    if (pattern.test(content)) {
      issues.push('Uses first person - should be third person ("Thiago worked on...")');
      score -= 15;
      break;
    }
  }

  // Check for required sections
  if (!content.includes('## Objective') && !content.includes('**Objective:**')) {
    issues.push('Missing Objective section');
    score -= 10;
  }

  if (!content.includes('**Outcome:**')) {
    issues.push('Missing Outcome in themes');
    score -= 10;
  }

  if (!content.includes('## References') && !content.includes('| # | Source |')) {
    issues.push('Missing References table');
    score -= 10;
  }

  if (!content.includes('Generated by TSA_CORTEX')) {
    issues.push('Missing signature');
    score -= 5;
  }

  // Check count reconciliation
  const countMatch = content.match(/\*\*Total\*\*.*?(\d+)/);
  if (countMatch) {
    const total = parseInt(countMatch[1]);
    const slackMatch = content.match(/Slack.*?(\d+)/);
    const driveMatch = content.match(/Drive.*?(\d+)/);
    const linearMatch = content.match(/Linear.*?(\d+)/);
    const localMatch = content.match(/Local.*?(\d+)/);
    const claudeMatch = content.match(/Claude.*?(\d+)/);

    const sum = (slackMatch ? parseInt(slackMatch[1]) : 0) +
                (driveMatch ? parseInt(driveMatch[1]) : 0) +
                (linearMatch ? parseInt(linearMatch[1]) : 0) +
                (localMatch ? parseInt(localMatch[1]) : 0) +
                (claudeMatch ? parseInt(claudeMatch[1]) : 0);

    if (sum !== total) {
      issues.push(`Count mismatch: sum is ${sum} but total shows ${total}`);
      score -= 15;
    }
  }

  return {
    valid: issues.length === 0,
    score: Math.max(0, score),
    issues,
  };
}

/**
 * Generate a worklog title based on period length
 */
export function generateWorklogTitle(ownerName: string, endDate: Date, periodDays: number): string {
  const yy = endDate.getFullYear().toString().slice(2);
  const mm = (endDate.getMonth() + 1).toString().padStart(2, '0');
  const dd = endDate.getDate().toString().padStart(2, '0');

  const prefix = periodDays >= 7 ? 'Weekly Worklog' : 'Worklog';
  return `[${prefix}]${yy}_${mm}_${dd} TSA ${ownerName}`;
}
