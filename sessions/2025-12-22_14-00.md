# Sessão: 2025-12-22 14:00

## Resumo
Configuração completa do TSA_CORTEX: instalação de dependências, configuração de credenciais (Slack, Linear, Google Drive), e refatoração do coletor Slack para usar Search API.

## Objetivos
- [x] Instalar dependências npm
- [x] Configurar credenciais no .env
- [x] Testar pipeline com dry-run
- [x] Corrigir erros de compatibilidade
- [x] Refatorar Slack para Search API
- [x] Configurar Google Drive OAuth

## Decisões Tomadas

| Decisão | Contexto | Alternativas Consideradas |
|---------|----------|---------------------------|
| date-fns v2.30.0 | Compatibilidade com date-fns-tz v2 | Upgrade date-fns-tz para v3 |
| Slack Search API | Bot token não tem acesso a canais sem membership | Channel listing com bot |
| User Token (xoxp-) | Necessário para search:read scope | Bot token (xoxb-) |
| Keywords configuráveis | Flexibilidade para diferentes usuários | Hardcoded keywords |
| Remover denylist_folders | Drive API precisa de folder IDs, não nomes | Mapear nomes para IDs |

## Conhecimentos Adquiridos

### Slack API
- **Bot Token (xoxb-)**: Só acessa canais onde o bot é membro
- **User Token (xoxp-)**: Acessa tudo que o usuário pode ver
- **search.messages API**: Requer scope `search:read` no User Token
- **Query syntax**: `from:me after:YYYY-MM-DD before:YYYY-MM-DD keyword`

### Google Drive API
- **OAuth2 Flow**: Precisa de redirect URI configurada
- **Refresh Token**: Gerado após consentimento do usuário
- **Query syntax**: `modifiedTime >= 'ISO_DATE'` para filtrar por data

### TypeScript/Node.js
- **date-fns v2 vs v3**: Funções renomeadas (`toZonedTime` → `utcToZonedTime`)
- **Type casting**: `as unknown as Type` para conversões incompatíveis
- **Null coalescing**: `value ?? undefined` para converter null em undefined

## Arquivos Criados/Modificados

| Arquivo | Ação | Descrição |
|---------|------|-----------|
| package.json | Modificado | date-fns downgrade para v2.30.0 |
| src/utils/datetime.ts | Modificado | utcToZonedTime em vez de toZonedTime |
| src/collectors/slack.ts | **Reescrito** | Search API em vez de channel listing |
| src/collectors/drive.ts | Modificado | null coalescing para parents/size |
| src/collectors/linear.ts | Modificado | Type casting para raw_data |
| src/collectors/local.ts | Modificado | Type casting para raw_data |
| config/default.json | Modificado | Adicionado search_keywords, removido denylist_folders |
| .env | Modificado | Todas as credenciais configuradas |
| scripts/get-google-token.js | Criado | Script para OAuth flow do Google |

## Código Destacado

```typescript
// Novo Slack Collector - Search-based
async collect(): Promise<CollectorResult> {
  const creds = getSlackCredentials();
  this.client = new WebClient(creds.userToken); // User token, não bot!

  const startDate = this.formatDateForSearch(this.dateRange.start);
  const endDate = this.formatDateForSearch(this.dateRange.end);

  // Buscar mensagens do usuário
  const query = "from:me after:" + startDate + " before:" + endDate;
  const messages = await this.searchMessages(query);

  // Buscar por keywords
  for (const keyword of keywords) {
    const keywordMessages = await this.searchMessages(
      keyword + " after:" + startDate + " before:" + endDate
    );
  }
}
```

## Problemas e Soluções

| Problema | Causa | Solução |
|----------|-------|---------|
| npm install falha | date-fns v3 incompatível com date-fns-tz v2 | Downgrade date-fns para ^2.30.0 |
| `toZonedTime` not found | Nome da função mudou na v2 | Usar `utcToZonedTime` |
| Type error em raw_data | Interface não tem index signature | Cast via `as unknown as Record<string, unknown>` |
| Slack `invalid_auth` | Token placeholder no .env | Configurar token real |
| Slack `missing_scope` | Bot token não tem search:read | Usar User token com search:read |
| Slack 0 channels | Bot não é membro de nenhum canal | Usar Search API |
| Drive `File not found: .` | denylist_folders com nome em vez de ID | Remover denylist_folders |

## Credenciais Configuradas

| Serviço | Token Type | Scopes |
|---------|------------|--------|
| Slack | User (xoxp-) | search:read |
| Linear | API Key | Full access |
| Google | OAuth2 Refresh | drive.readonly |

## Métricas Finais

| Coletor | Eventos | Tempo |
|---------|---------|-------|
| Slack | 1854 | ~30s |
| Linear | 6 | ~2s |
| Drive | 145 | ~5s |
| Local | 50 | ~1s |
| **Total** | **2055** | ~40s |

## Tarefas Completadas
- [x] npm install com correção de dependências
- [x] Configuração Slack (User Token + search:read)
- [x] Configuração Linear (API Key)
- [x] Configuração Google Drive (OAuth2)
- [x] Refatoração completa do Slack Collector
- [x] Correções TypeScript em todos os coletores
- [x] Teste dry-run bem-sucedido

## Novas Tarefas Identificadas
- [ ] Testar post real no Linear
- [ ] Implementar testes unitários
- [ ] Documentar processo de setup para novos usuários
- [ ] Adicionar mais keywords configuráveis via CLI
- [ ] Implementar coletor Claude (se API disponível)

## Próximos Passos
1. Testar criação de ticket real no Linear (sem --dry-run)
2. Validar output do worklog
3. Documentar processo completo de setup

---
*Sessão consolidada em: 2025-12-22T16:45:00-03:00*
